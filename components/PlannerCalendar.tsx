import { Text } from "@/components/Themed";
import { Schedule, ScheduleCategory } from "@/models/types";
import dayjs from "dayjs";
import React, { useMemo, useState } from "react";
import {
  Alert,
  Animated,
  Clipboard,
  Linking,
  Modal,
  Pressable,
  ScrollView,
  Switch,
  TextInput,
  View,
} from "react-native";
import { Calendar } from "react-native-calendars";
import { PanGestureHandler, State } from "react-native-gesture-handler";

function getCategoryColor(category: ScheduleCategory): string {
  const colors: Record<ScheduleCategory, string> = {
    education: "#8b5cf6",
    meeting: "#3b82f6",
    event: "#ef4444",
    others: "#6b7280",
  };
  return colors[category] || colors.others;
}

function getSchedulePosition(
  schedule: Schedule,
  hourHeight: number
): { top: number; height: number } {
  const times = schedule.workers.flatMap((w) =>
    w.periods.map((p) => ({
      start: dayjs(p.start),
      end: dayjs(p.end),
    }))
  );

  const start = times.reduce(
    (min: dayjs.Dayjs, t: { start: dayjs.Dayjs; end: dayjs.Dayjs }) =>
      t.start.isBefore(min) ? t.start : min,
    times[0].start
  );
  const end = times.reduce(
    (max: dayjs.Dayjs, t: { start: dayjs.Dayjs; end: dayjs.Dayjs }) =>
      t.end.isAfter(max) ? t.end : max,
    times[0].end
  );

  const startHour = start.hour() + start.minute() / 60;
  const endHour = end.hour() + end.minute() / 60;
  const duration = endHour - startHour;

  return {
    top: startHour * hourHeight,
    height: Math.max(duration * hourHeight, 20),
  };
}

export default function PlannerCalendar() {
  const [selectedDate, setSelectedDate] = useState<string>(
    dayjs().format("YYYY-MM-DD")
  );
  const [currentMonth, setCurrentMonth] = useState<string>(
    dayjs().format("YYYY-MM")
  );

  const [selectedScheduleId, setSelectedScheduleId] = useState<string | null>(
    null
  );
  const [modalVisible, setModalVisible] = useState(false);
  const [modalType, setModalType] = useState<
    "timetable" | "detail" | "worker-detail" | null
  >(null);
  const [selectedWorkerIndex, setSelectedWorkerIndex] = useState<number | null>(
    null
  );
  const [showPaymentModal, setShowPaymentModal] = useState(false);
  const [taxWithheld, setTaxWithheld] = useState(false);
  const [taxRate, setTaxRate] = useState(0.1);
  const [paid, setPaid] = useState(false);
  const [workHours, setWorkHours] = useState<Record<string, number>>({});
  const [workerData, setWorkerData] = useState<Record<string, any>>({});
  const [showAddWorkerModal, setShowAddWorkerModal] = useState(false);
  const [newWorker, setNewWorker] = useState({
    name: "",
    phone: "",
    bankAccount: "",
    hourlyWage: 0,
    taxWithheld: true,
  });
  // Ï†ïÏ†Å ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞
  const [schedules, setSchedules] = useState<Schedule[]>(() => {
    const today = dayjs().format("YYYY-MM-DD");
    const tomorrow = dayjs().add(1, "day").format("YYYY-MM-DD");

    return [
      {
        id: "1",
        title: "ÏàòÌïô Í≥ºÏô∏",
        date: today,
        description: "Í≥†Îì±ÌïôÍµê 2ÌïôÎÖÑ ÏàòÌïô Í≥ºÏô∏",
        category: "education",
        workers: [
          {
            worker: {
              id: "w1",
              name: "ÍπÄÏÑ†ÏÉù",
              phone: "010-1234-5678",
              bankAccount: "123-456-789",
              hourlyWage: 50000,
              taxWithheld: true,
            },
            periods: [
              {
                id: "p1",
                start: `${today}T14:00:00+09:00`,
                end: `${today}T16:00:00+09:00`,
              },
            ],
            paid: false,
          },
        ],
      },
      {
        id: "2",
        title: "ÏòÅÏñ¥ ÌöåÌôî",
        date: today,
        description: "ÏÑ±Ïù∏ ÏòÅÏñ¥ ÌöåÌôî ÏàòÏóÖ",
        category: "education",
        workers: [
          {
            worker: {
              id: "w2",
              name: "Sarah Johnson",
              phone: "010-9876-5432",
              bankAccount: "987-654-321",
              hourlyWage: 80000,
              taxWithheld: false,
            },
            periods: [
              {
                id: "p2",
                start: `${today}T19:00:00+09:00`,
                end: `${today}T21:00:00+09:00`,
              },
            ],
            paid: false,
          },
        ],
      },
      {
        id: "3",
        title: "ÌîÑÎ°úÏ†ùÌä∏ ÌöåÏùò",
        date: tomorrow,
        description: "Ïõπ Í∞úÎ∞ú ÌîÑÎ°úÏ†ùÌä∏ ÏßÑÌñâ ÌöåÏùò",
        category: "meeting",
        workers: [
          {
            worker: {
              id: "w3",
              name: "Ïù¥Í∞úÎ∞ú",
              phone: "010-5555-1234",
              bankAccount: "555-123-456",
              hourlyWage: 100000,
              taxWithheld: true,
            },
            periods: [
              {
                id: "p3",
                start: `${tomorrow}T10:00:00+09:00`,
                end: `${tomorrow}T12:00:00+09:00`,
              },
            ],
            paid: false,
          },
        ],
      },
    ];
  });
  const [loading, setLoading] = useState(false);

  const translateY = new Animated.Value(0);

  const showModal = () => {
    setModalVisible(true);
    Animated.spring(translateY, {
      toValue: 0,
      useNativeDriver: true,
    }).start();
  };

  const hideModal = () => {
    Animated.timing(translateY, {
      toValue: 300,
      useNativeDriver: true,
    }).start(() => {
      setModalVisible(false);
      setModalType(null);
      setSelectedScheduleId(null);
    });
  };

  const onGestureEvent = Animated.event(
    [{ nativeEvent: { translationY: translateY } }],
    { useNativeDriver: true }
  );

  const onHandlerStateChange = (event: any) => {
    if (event.nativeEvent.state === State.END) {
      if (event.nativeEvent.translationY > 100) {
        hideModal();
      } else {
        Animated.spring(translateY, {
          toValue: 0,
          useNativeDriver: true,
        }).start();
      }
    }
  };

  const monthMarks = useMemo(() => {
    const marks: Record<
      string,
      { dots: { color: string }[]; marked?: boolean }
    > = {};

    schedules.forEach((schedule: Schedule) => {
      const date = dayjs(schedule.date).format("YYYY-MM-DD");
      if (!marks[date]) {
        marks[date] = { dots: [] };
      }
      marks[date].dots.push({
        color: getCategoryColor(schedule.category),
      });
      marks[date].marked = true;
    });

    return marks;
  }, [schedules]);

  const selectedDateSchedules = useMemo(() => {
    return schedules
      .filter((s) => s.date === selectedDate)
      .slice()
      .sort((a, b) => {
        const aStart = a.workers
          .flatMap((w) => w.periods.map((p) => dayjs(p.start)))
          .sort((x, y) => x.valueOf() - y.valueOf())[0];
        const bStart = b.workers
          .flatMap((w) => w.periods.map((p) => dayjs(p.start)))
          .sort((x, y) => x.valueOf() - y.valueOf())[0];
        return (aStart?.valueOf() ?? 0) - (bStart?.valueOf() ?? 0);
      });
  }, [schedules, selectedDate]);

  const goToPreviousMonth = () => {
    const newMonth = dayjs(currentMonth).subtract(1, "month").format("YYYY-MM");
    setCurrentMonth(newMonth);
  };

  const goToNextMonth = () => {
    const newMonth = dayjs(currentMonth).add(1, "month").format("YYYY-MM");
    setCurrentMonth(newMonth);
  };

  const onSchedulePress = (scheduleId: string) => {
    setSelectedScheduleId(scheduleId);
    setModalType("detail");
    showModal();
  };

  const makePhoneCall = (phoneNumber: string) => {
    Linking.openURL(`tel:${phoneNumber}`);
  };

  const sendSMS = (phoneNumber: string) => {
    Linking.openURL(`sms:${phoneNumber}`);
  };

  const showContactOptions = (phoneNumber: string) => {
    Alert.alert("Ïó∞ÎùΩÌïòÍ∏∞", "Ïñ¥Îñ§ Î∞©Î≤ïÏúºÎ°ú Ïó∞ÎùΩÌïòÏãúÍ≤†ÏäµÎãàÍπå?", [
      {
        text: "üìû Ï†ÑÌôîÍ±∏Í∏∞",
        onPress: () => makePhoneCall(phoneNumber),
      },
      {
        text: "üí¨ Î¨∏ÏûêÎ≥¥ÎÇ¥Í∏∞",
        onPress: () => sendSMS(phoneNumber),
      },
      { text: "Ï∑®ÏÜå", style: "cancel" },
    ]);
  };

  const calculatePay = (workerInfo: any, customHours?: number) => {
    const hours =
      customHours ||
      workHours[workerInfo.worker.id] ||
      workerInfo.periods.reduce((total: number, period: any) => {
        const start = dayjs(period.start);
        const end = dayjs(period.end);
        return total + end.diff(start, "hour", true);
      }, 0);

    // workerDataÏóêÏÑú ÏãúÍ∏âÍ≥º ÏÑ∏Í∏àÍ≥µÏ†ú Ïó¨Î∂Ä Í∞ÄÏ†∏Ïò§Í∏∞
    const workerDataForId = workerData[workerInfo.worker.id] || {};
    const hourlyWage =
      workerDataForId.hourlyWage || workerInfo.worker.hourlyWage;
    const taxWithheld =
      workerDataForId.taxWithheld !== undefined
        ? workerDataForId.taxWithheld
        : workerInfo.worker.taxWithheld;

    const grossPay = hourlyWage * hours;

    if (taxWithheld) {
      // 3.3% Í≥µÏ†ú
      const taxAmount = grossPay * 0.033;
      return {
        gross: grossPay,
        tax: taxAmount,
        net: grossPay - taxAmount,
        taxWithheld: true,
      };
    } else {
      return {
        gross: grossPay,
        tax: 0,
        net: grossPay,
        taxWithheld: false,
      };
    }
  };

  const updateWorkHours = (workerId: string, hours: number) => {
    setWorkHours((prev) => ({
      ...prev,
      [workerId]: hours,
    }));
  };

  const updateWorkerData = (workerId: string, data: any) => {
    setWorkerData((prev) => ({
      ...prev,
      [workerId]: { ...prev[workerId], ...data },
    }));
  };

  const formatWorkHours = (hours: number): string => {
    const wholeHours = Math.floor(hours);
    const minutes = Math.round((hours - wholeHours) * 60);
    return `${wholeHours}ÏãúÍ∞Ñ ${minutes.toString().padStart(2, "0")}Î∂Ñ`;
  };

  const parseWorkHours = (input: string): number => {
    const match = input.match(/(\d+)ÏãúÍ∞Ñ\s*(\d+)?Î∂Ñ?/);
    if (match) {
      const hours = parseInt(match[1]) || 0;
      const minutes = parseInt(match[2] || "0") || 0;
      return hours + minutes / 60;
    }
    return parseFloat(input) || 0;
  };

  const addWorkerToSchedule = (scheduleId: string, worker: any) => {
    setSchedules((prevSchedules) =>
      prevSchedules.map((schedule) => {
        if (schedule.id === scheduleId) {
          const newWorkerId = `w${Date.now()}`;
          const newWorkerInfo = {
            worker: {
              id: newWorkerId,
              name: worker.name,
              phone: worker.phone,
              bankAccount: worker.bankAccount,
              hourlyWage: worker.hourlyWage,
              taxWithheld: worker.taxWithheld,
            },
            periods: [
              {
                id: `p${Date.now()}`,
                start: `${schedule.date}T09:00:00+09:00`,
                end: `${schedule.date}T17:00:00+09:00`,
              },
            ],
            paid: false,
          };
          return {
            ...schedule,
            workers: [...schedule.workers, newWorkerInfo],
          };
        }
        return schedule;
      })
    );
  };

  const handleAddWorker = () => {
    if (
      !newWorker.name ||
      !newWorker.phone ||
      !newWorker.bankAccount ||
      newWorker.hourlyWage <= 0
    ) {
      Alert.alert("Ïò§Î•ò", "Î™®Îì† ÌïÑÎìúÎ•º Ïò¨Î∞îÎ•¥Í≤å ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
      return;
    }

    // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Ïä§ÏºÄÏ§ÑÏóê Í∑ºÎ°úÏûê Ï∂îÍ∞Ä
    if (selectedScheduleId) {
      addWorkerToSchedule(selectedScheduleId, newWorker);
      setShowAddWorkerModal(false);
      setNewWorker({
        name: "",
        phone: "",
        bankAccount: "",
        hourlyWage: 0,
        taxWithheld: true,
      });
      Alert.alert("ÏÑ±Í≥µ", "Í∑ºÎ°úÏûêÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.");
    }
  };

  const copyToClipboard = (text: string) => {
    Clipboard.setString(text);
    Alert.alert("Î≥µÏÇ¨Îê®", "Í≥ÑÏ¢åÎ≤àÌò∏Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.");
  };

  const openPaymentApp = (bankAccount: string) => {
    Alert.alert("ÏÜ°Í∏àÌïòÍ∏∞", "Ïñ¥Îñ§ Ïï±ÏúºÎ°ú ÏÜ°Í∏àÌïòÏãúÍ≤†ÏäµÎãàÍπå?", [
      {
        text: "Ïπ¥Ïπ¥Ïò§Î±ÖÌÅ¨",
        onPress: () => {
          // Ïπ¥Ïπ¥Ïò§Î±ÖÌÅ¨ Ïï± Ïó¥Í∏∞ (Ïã§Ï†úÎ°úÎäî deep link ÏÇ¨Ïö©)
          Linking.openURL(`kakaobank://transfer?account=${bankAccount}`);
        },
      },
      {
        text: "ÌÜ†Ïä§Î±ÖÌÅ¨",
        onPress: () => {
          // ÌÜ†Ïä§Î±ÖÌÅ¨ Ïï± Ïó¥Í∏∞ (Ïã§Ï†úÎ°úÎäî deep link ÏÇ¨Ïö©)
          Linking.openURL(`toss://transfer?account=${bankAccount}`);
        },
      },
      { text: "Ï∑®ÏÜå", style: "cancel" },
    ]);
  };

  return (
    <View style={{ flex: 1, backgroundColor: "white" }}>
      {/* Ï†ÑÏ≤¥ ÌôîÎ©¥ Îã¨Î†• */}
      <View style={{ flex: 1 }}>
        <Calendar
          current={currentMonth}
          markingType="custom"
          markedDates={{
            ...monthMarks,
            [selectedDate]: {
              ...((monthMarks[selectedDate] ?? { dots: [] }) as any),
              customStyles: {
                container: {
                  backgroundColor: "rgba(37,99,235,0.3)",
                  borderRadius: 8,
                  borderWidth: 2,
                  borderColor: "#2563eb",
                },
              },
            } as any,
          }}
          theme={{
            selectedDayBackgroundColor: "transparent",
            todayTextColor: "#2563eb",
            calendarBackground: "white",
            textSectionTitleColor: "#6b7280",
            dayTextColor: "#1f2937",
            textDisabledColor: "#d1d5db",
            arrowColor: "#2563eb",
            monthTextColor: "#1f2937",
            indicatorColor: "#2563eb",
            textDayFontWeight: "500",
            textMonthFontWeight: "600",
            textDayHeaderFontWeight: "600",
          }}
          dayComponent={({ date }) => {
            const key = date?.dateString ?? "";
            const daily = schedules.filter((s) => s.date === key);
            const sorted = daily.slice().sort((a, b) => {
              const aStart = a.workers
                .flatMap((w) => w.periods.map((p) => dayjs(p.start)))
                .sort((x, y) => x.valueOf() - y.valueOf())[0];
              const bStart = b.workers
                .flatMap((w) => w.periods.map((p) => dayjs(p.start)))
                .sort((x, y) => x.valueOf() - y.valueOf())[0];
              return (aStart?.valueOf() ?? 0) - (bStart?.valueOf() ?? 0);
            });

            const handleDayPress = () => {
              setSelectedDate(key);
              setSelectedScheduleId(null);
              setModalType("timetable");
              setTimeout(() => {
                showModal();
              }, 0);
            };

            return (
              <Pressable
                style={{ flex: 1, minHeight: 80, padding: 2 }}
                onPress={handleDayPress}
              >
                <Text
                  style={{
                    fontSize: 16,
                    fontWeight: "500",
                    textAlign: "center",
                    marginBottom: 4,
                  }}
                >
                  {date?.day}
                </Text>
                <View style={{ flex: 1, gap: 2 }}>
                  {sorted.slice(0, 3).map((schedule, index) => (
                    <Pressable
                      key={schedule.id}
                      onPress={(e) => {
                        e.stopPropagation();
                        onSchedulePress(schedule.id);
                      }}
                      style={{
                        backgroundColor: getCategoryColor(schedule.category),
                        borderRadius: 4,
                        padding: 2,
                        marginBottom: 1,
                      }}
                    >
                      <Text
                        style={{
                          fontSize: 10,
                          color: "white",
                          fontWeight: "500",
                        }}
                        numberOfLines={1}
                      >
                        {schedule.title}
                      </Text>
                    </Pressable>
                  ))}
                  {sorted.length > 3 && (
                    <Text
                      style={{
                        fontSize: 10,
                        color: "#6b7280",
                        textAlign: "center",
                      }}
                    >
                      +{sorted.length - 3} more
                    </Text>
                  )}
                </View>
              </Pressable>
            );
          }}
        />
      </View>

      {/* Î™®Îã¨ */}
      {modalVisible && (
        <Animated.View
          style={{
            position: "absolute",
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: "rgba(0,0,0,0.5)",
            transform: [{ translateY }],
          }}
        >
          <PanGestureHandler
            onGestureEvent={onGestureEvent}
            onHandlerStateChange={onHandlerStateChange}
          >
            <Animated.View
              style={{
                flex: 1,
                justifyContent: "flex-end",
                transform: [{ translateY }],
              }}
            >
              <View
                style={{
                  flex: 1,
                  backgroundColor: "white",
                  borderTopLeftRadius: 20,
                  borderTopRightRadius: 20,
                  overflow: "hidden",
                }}
              >
                {/* ÎìúÎûòÍ∑∏ Ìï∏Îì§Îü¨ */}
                <View
                  style={{
                    height: 30,
                    justifyContent: "center",
                    alignItems: "center",
                    borderTopLeftRadius: 20,
                    borderTopRightRadius: 20,
                    backgroundColor: "#f8f9fa",
                  }}
                >
                  <View
                    style={{
                      width: 40,
                      height: 4,
                      backgroundColor: "#9ca3af",
                      borderRadius: 2,
                    }}
                  />
                </View>

                {/* Î™®Îã¨ ÎÇ¥Ïö© */}
                <View style={{ flex: 1 }}>
                  {modalType === "timetable" && (
                    <View style={{ flex: 1 }}>
                      {/* ÎÇ†Ïßú Ìó§Îçî */}
                      <View
                        style={{
                          padding: 16,
                          borderBottomWidth: 1,
                          borderBottomColor: "#e5e7eb",
                        }}
                      >
                        <Text
                          style={{
                            fontSize: 18,
                            fontWeight: "600",
                            textAlign: "center",
                          }}
                        >
                          {dayjs(selectedDate).format("YYYYÎÖÑ MÏõî DÏùº dddd")}
                        </Text>
                      </View>

                      {/* ÌÉÄÏûÑÌÖåÏù¥Î∏î */}
                      <ScrollView style={{ flex: 1 }}>
                        <View style={{ flexDirection: "row", minHeight: 960 }}>
                          {/* ÏãúÍ∞Ñ ÎùºÎ≤® */}
                          <View
                            style={{ width: 60, backgroundColor: "#f8f9fa" }}
                          >
                            {Array.from({ length: 24 }, (_, i) => {
                              const hour = i;
                              return (
                                <View
                                  key={hour}
                                  style={{
                                    height: 40,
                                    justifyContent: "center",
                                    paddingLeft: 8,
                                  }}
                                >
                                  <Text style={{ fontSize: 11, color: "#666" }}>
                                    {hour.toString().padStart(2, "0")}:00
                                  </Text>
                                </View>
                              );
                            })}
                          </View>

                          {/* ÌÉÄÏûÑÌÖåÏù¥Î∏î ÏòÅÏó≠ */}
                          <View
                            style={{
                              flex: 1,
                              position: "relative",
                              minHeight: 960,
                            }}
                          >
                            {/* ÏãúÍ∞Ñ ÎùºÏù∏ */}
                            {Array.from({ length: 24 }, (_, i) => (
                              <View
                                key={i}
                                style={{
                                  height: 40,
                                  borderBottomWidth: 1,
                                  borderBottomColor: "#e5e7eb",
                                }}
                              />
                            ))}

                            {/* Ïä§ÏºÄÏ§Ñ Î∏îÎü≠Îì§ */}
                            {selectedDateSchedules.map((schedule, index) => {
                              const position = getSchedulePosition(
                                schedule,
                                40
                              );

                              // ÏãúÍ∞Ñ Î≤îÏúÑÍ∞Ä 0~23Ïãú ÎÇ¥Ïóê ÏûàÎäîÏßÄ ÌôïÏù∏
                              if (position.top < 0 || position.top > 920) {
                                return null;
                              }

                              // Í≤πÏπòÎäî Ïä§ÏºÄÏ§ÑÎì§ÏùÑ Ï∞æÏïÑÏÑú ÏúÑÏπò Í≥ÑÏÇ∞
                              const overlappingSchedules =
                                selectedDateSchedules.filter((s, i) => {
                                  if (i === index) return false;
                                  const otherPos = getSchedulePosition(s, 40);
                                  return !(
                                    position.top + position.height <=
                                      otherPos.top ||
                                    position.top >=
                                      otherPos.top + otherPos.height
                                  );
                                });

                              const totalOverlapping =
                                overlappingSchedules.length + 1;
                              const blockWidth = 100 / totalOverlapping - 2;
                              const blockLeft =
                                (index % totalOverlapping) *
                                  (100 / totalOverlapping) +
                                1;

                              // ÏãúÏûë/Ï¢ÖÎ£å ÏãúÍ∞Ñ ÌëúÏãú
                              const times = schedule.workers.flatMap((w) =>
                                w.periods.map((p) => ({
                                  start: dayjs(p.start),
                                  end: dayjs(p.end),
                                }))
                              );
                              const start = times.reduce(
                                (
                                  min: dayjs.Dayjs,
                                  t: { start: dayjs.Dayjs; end: dayjs.Dayjs }
                                ) => (t.start.isBefore(min) ? t.start : min),
                                times[0].start
                              );
                              const end = times.reduce(
                                (
                                  max: dayjs.Dayjs,
                                  t: { start: dayjs.Dayjs; end: dayjs.Dayjs }
                                ) => (t.end.isAfter(max) ? t.end : max),
                                times[0].end
                              );

                              return (
                                <Pressable
                                  key={schedule.id}
                                  onPress={() => onSchedulePress(schedule.id)}
                                  style={{
                                    position: "absolute",
                                    top: position.top,
                                    height: Math.max(position.height, 20),
                                    left: `${blockLeft}%`,
                                    width: `${blockWidth}%`,
                                    backgroundColor: getCategoryColor(
                                      schedule.category
                                    ),
                                    borderRadius: 6,
                                    padding: 4,
                                    margin: 1,
                                    shadowColor: "#000",
                                    shadowOffset: { width: 0, height: 1 },
                                    shadowOpacity: 0.2,
                                    shadowRadius: 2,
                                    elevation: 2,
                                  }}
                                >
                                  <Text
                                    style={{
                                      fontSize: 11,
                                      fontWeight: "600",
                                      color: "white",
                                      lineHeight: 12,
                                    }}
                                    numberOfLines={1}
                                  >
                                    {schedule.title}
                                  </Text>
                                  <Text
                                    style={{
                                      fontSize: 9,
                                      color: "white",
                                      lineHeight: 10,
                                      marginTop: 1,
                                    }}
                                    numberOfLines={1}
                                  >
                                    {start.format("HH:mm")} -{" "}
                                    {end.format("HH:mm")}
                                  </Text>
                                </Pressable>
                              );
                            })}
                          </View>
                        </View>
                      </ScrollView>
                    </View>
                  )}

                  {modalType === "detail" && selectedScheduleId && (
                    <View style={{ flex: 1 }}>
                      {/* ÏÉÅÏÑ∏ Ìó§Îçî */}
                      <View
                        style={{
                          padding: 16,
                          borderBottomWidth: 1,
                          borderBottomColor: "#e5e7eb",
                        }}
                      >
                        <Pressable
                          onPress={() => {
                            setModalType("timetable");
                            // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÎÇ†ÏßúÎ°ú ÌÉÄÏûÑÌÖåÏù¥Î∏î ÌëúÏãú
                            setSelectedDate(selectedDate);
                          }}
                        >
                          <Text style={{ fontSize: 16, color: "#2563eb" }}>
                            ‚Üê ÌÉÄÏûÑÌÖåÏù¥Î∏îÎ°ú
                          </Text>
                        </Pressable>
                      </View>

                      {/* ÏÉÅÏÑ∏ ÎÇ¥Ïö© */}
                      <View style={{ padding: 16 }}>
                        {(() => {
                          const schedule = schedules.find(
                            (s) => s.id === selectedScheduleId
                          );
                          if (!schedule)
                            return <Text>Ïä§ÏºÄÏ•¥ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</Text>;
                          return (
                            <View>
                              <Text
                                style={{
                                  fontSize: 24,
                                  fontWeight: "bold",
                                  marginBottom: 16,
                                }}
                              >
                                {schedule.title}
                              </Text>
                              <Text style={{ fontSize: 16, marginBottom: 16 }}>
                                {dayjs(schedule.date).format(
                                  "YYYYÎÖÑ MÏõî DÏùº dddd"
                                )}
                              </Text>
                              <Text style={{ fontSize: 16, marginBottom: 16 }}>
                                {schedule.description}
                              </Text>

                              {/* ÏùºÌïòÎäî ÏÇ¨ÎûåÎì§ Í∞ÑÎã® Ï†ïÎ≥¥ */}
                              <View style={{ marginTop: 16 }}>
                                <View
                                  style={{
                                    flexDirection: "row",
                                    justifyContent: "space-between",
                                    alignItems: "center",
                                    marginBottom: 12,
                                  }}
                                >
                                  <Text
                                    style={{
                                      fontSize: 18,
                                      fontWeight: "600",
                                    }}
                                  >
                                    ÏùºÌïòÎäî ÏÇ¨ÎûåÎì§
                                  </Text>
                                  <View
                                    style={{ flexDirection: "row", gap: 8 }}
                                  >
                                    <Pressable
                                      onPress={() =>
                                        setShowAddWorkerModal(true)
                                      }
                                      style={{
                                        backgroundColor: "#10b981",
                                        paddingHorizontal: 12,
                                        paddingVertical: 6,
                                        borderRadius: 6,
                                      }}
                                    >
                                      <Text
                                        style={{ color: "white", fontSize: 12 }}
                                      >
                                        + Ï∂îÍ∞Ä
                                      </Text>
                                    </Pressable>
                                    <Pressable
                                      onPress={() => {
                                        setModalType("worker-detail");
                                        setSelectedWorkerIndex(0); // Ï≤´ Î≤àÏß∏ Í∑ºÎ°úÏûêÎ°ú Ï¥àÍ∏∞Ìôî
                                      }}
                                      style={{
                                        backgroundColor: "#2563eb",
                                        paddingHorizontal: 12,
                                        paddingVertical: 6,
                                        borderRadius: 6,
                                      }}
                                    >
                                      <Text
                                        style={{ color: "white", fontSize: 12 }}
                                      >
                                        ÏÉÅÏÑ∏Î≥¥Í∏∞
                                      </Text>
                                    </Pressable>
                                  </View>
                                </View>

                                {schedule.workers.map((workerInfo, index) => (
                                  <View
                                    key={index}
                                    style={{
                                      backgroundColor: "#f8f9fa",
                                      padding: 16,
                                      borderRadius: 8,
                                      marginBottom: 12,
                                    }}
                                  >
                                    {/* Í∑ºÎ°úÏûê Ïù¥Î¶Ñ */}
                                    <Text
                                      style={{
                                        fontSize: 18,
                                        fontWeight: "600",
                                        marginBottom: 8,
                                      }}
                                    >
                                      {workerInfo.worker.name}
                                    </Text>

                                    {/* Ìè¨ÏßÄÏÖò */}
                                    <Text
                                      style={{
                                        fontSize: 14,
                                        color: "#6b7280",
                                        marginBottom: 6,
                                      }}
                                    >
                                      Ìè¨ÏßÄÏÖò:{" "}
                                      {workerInfo.worker.name.includes("ÏÑ†ÏÉù")
                                        ? "Í∞ïÏÇ¨"
                                        : workerInfo.worker.name.includes(
                                            "Í∞úÎ∞ú"
                                          )
                                        ? "Í∞úÎ∞úÏûê"
                                        : workerInfo.worker.name.includes(
                                            "Ïù¥Î≤§Ìä∏"
                                          )
                                        ? "Ïù¥Î≤§Ìä∏ Îã¥Îãπ"
                                        : "Í∑ºÎ°úÏûê"}
                                    </Text>

                                    {/* Í∑ºÎ¨¥Ïó¨Î∂Ä */}
                                    <View
                                      style={{
                                        flexDirection: "row",
                                        alignItems: "center",
                                        marginBottom: 8,
                                      }}
                                    >
                                      <View
                                        style={{
                                          width: 8,
                                          height: 8,
                                          borderRadius: 4,
                                          backgroundColor: workerInfo.paid
                                            ? "#10b981"
                                            : "#f59e0b",
                                          marginRight: 6,
                                        }}
                                      />
                                      <Text
                                        style={{
                                          fontSize: 14,
                                          color: workerInfo.paid
                                            ? "#10b981"
                                            : "#f59e0b",
                                          fontWeight: "500",
                                        }}
                                      >
                                        {workerInfo.paid
                                          ? "Í∑ºÎ¨¥ÏôÑÎ£å"
                                          : "Í∑ºÎ¨¥ÏòàÏ†ï"}
                                      </Text>
                                    </View>

                                    {/* Ï†ÑÌôîÎ≤àÌò∏ÏôÄ Ïó∞ÎùΩ Î≤ÑÌäºÎì§ */}
                                    <View
                                      style={{
                                        flexDirection: "row",
                                        alignItems: "center",
                                        justifyContent: "space-between",
                                        marginBottom: 12,
                                      }}
                                    >
                                      <Text
                                        style={{
                                          fontSize: 14,
                                          color: "#1f2937",
                                          flex: 1,
                                        }}
                                      >
                                        {workerInfo.worker.phone}
                                      </Text>
                                      <View
                                        style={{ flexDirection: "row", gap: 8 }}
                                      >
                                        <Pressable
                                          onPress={() =>
                                            makePhoneCall(
                                              workerInfo.worker.phone
                                            )
                                          }
                                          style={{
                                            backgroundColor: "#2563eb",
                                            paddingHorizontal: 8,
                                            paddingVertical: 4,
                                            borderRadius: 4,
                                          }}
                                        >
                                          <Text
                                            style={{
                                              color: "white",
                                              fontSize: 12,
                                            }}
                                          >
                                            üìû
                                          </Text>
                                        </Pressable>
                                        <Pressable
                                          onPress={() =>
                                            sendSMS(workerInfo.worker.phone)
                                          }
                                          style={{
                                            backgroundColor: "#10b981",
                                            paddingHorizontal: 8,
                                            paddingVertical: 4,
                                            borderRadius: 4,
                                          }}
                                        >
                                          <Text
                                            style={{
                                              color: "white",
                                              fontSize: 12,
                                            }}
                                          >
                                            üí¨
                                          </Text>
                                        </Pressable>
                                        <Pressable
                                          onPress={() =>
                                            showContactOptions(
                                              workerInfo.worker.phone
                                            )
                                          }
                                          style={{
                                            backgroundColor: "#6b7280",
                                            paddingHorizontal: 8,
                                            paddingVertical: 4,
                                            borderRadius: 4,
                                          }}
                                        >
                                          <Text
                                            style={{
                                              color: "white",
                                              fontSize: 12,
                                            }}
                                          >
                                            ‚ãØ
                                          </Text>
                                        </Pressable>
                                      </View>
                                    </View>

                                    {/* ÏãúÍ∏â Î∞è Í∑ºÎ¨¥ÏãúÍ∞Ñ */}
                                    <View
                                      style={{
                                        flexDirection: "row",
                                        alignItems: "center",
                                        justifyContent: "space-between",
                                      }}
                                    >
                                      <Text
                                        style={{
                                          fontSize: 12,
                                          color: "#6b7280",
                                        }}
                                      >
                                        ÏãúÍ∏â:{" "}
                                        {workerInfo.worker.hourlyWage.toLocaleString()}
                                        Ïõê
                                      </Text>
                                      <Text
                                        style={{
                                          fontSize: 12,
                                          color: "#6b7280",
                                        }}
                                      >
                                        Í∑ºÎ¨¥ÏãúÍ∞Ñ:{" "}
                                        {(() => {
                                          const totalHours =
                                            workerInfo.periods.reduce(
                                              (total, period) => {
                                                const start = dayjs(
                                                  period.start
                                                );
                                                const end = dayjs(period.end);
                                                return (
                                                  total +
                                                  end.diff(start, "hour", true)
                                                );
                                              },
                                              0
                                            );
                                          return `${totalHours.toFixed(1)}ÏãúÍ∞Ñ`;
                                        })()}
                                      </Text>
                                    </View>
                                  </View>
                                ))}
                              </View>
                            </View>
                          );
                        })()}
                      </View>
                    </View>
                  )}

                  {modalType === "worker-detail" && selectedScheduleId && (
                    <View style={{ flex: 1 }}>
                      {/* ÏÉÅÏÑ∏ Ìó§Îçî */}
                      <View
                        style={{
                          padding: 16,
                          borderBottomWidth: 1,
                          borderBottomColor: "#e5e7eb",
                        }}
                      >
                        <Pressable
                          onPress={() => {
                            setModalType("detail");
                            setSelectedWorkerIndex(null);
                          }}
                        >
                          <Text style={{ fontSize: 16, color: "#2563eb" }}>
                            ‚Üê Ïä§ÏºÄÏ§Ñ ÏÉÅÏÑ∏Î°ú
                          </Text>
                        </Pressable>
                      </View>

                      {/* ÏùºÌïòÎäî ÏÇ¨ÎûåÎì§ Í∑∏Î¶¨Îìú */}
                      <ScrollView style={{ flex: 1, padding: 16 }}>
                        {(() => {
                          const schedule = schedules.find(
                            (s) => s.id === selectedScheduleId
                          );
                          if (!schedule) {
                            return <Text>Ïä§ÏºÄÏ§Ñ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</Text>;
                          }

                          return (
                            <View>
                              <View
                                style={{
                                  flexDirection: "row",
                                  justifyContent: "space-between",
                                  alignItems: "center",
                                  marginBottom: 16,
                                }}
                              >
                                <Text
                                  style={{
                                    fontSize: 20,
                                    fontWeight: "bold",
                                  }}
                                >
                                  ÏùºÌïòÎäî ÏÇ¨ÎûåÎì§ Í¥ÄÎ¶¨
                                </Text>
                                <Pressable
                                  onPress={() => setShowAddWorkerModal(true)}
                                  style={{
                                    backgroundColor: "#10b981",
                                    paddingHorizontal: 12,
                                    paddingVertical: 8,
                                    borderRadius: 6,
                                  }}
                                >
                                  <Text
                                    style={{
                                      color: "white",
                                      fontSize: 14,
                                      fontWeight: "600",
                                    }}
                                  >
                                    + Í∑ºÎ°úÏûê Ï∂îÍ∞Ä
                                  </Text>
                                </Pressable>
                              </View>

                              {/* Í∑∏Î¶¨Îìú Î†àÏù¥ÏïÑÏõÉ */}
                              <View
                                style={{
                                  flexDirection: "row",
                                  flexWrap: "wrap",
                                  justifyContent: "space-between",
                                  gap: 12,
                                }}
                              >
                                {schedule.workers.map((workerInfo, index) => (
                                  <View
                                    key={index}
                                    style={{
                                      backgroundColor: "#f8f9fa",
                                      padding: 16,
                                      borderRadius: 12,
                                      width: "48%",
                                      minHeight: 200,
                                      borderWidth: 1,
                                      borderColor: "#e5e7eb",
                                    }}
                                  >
                                    {/* Í∑ºÎ°úÏûê Ïù¥Î¶Ñ */}
                                    <Text
                                      style={{
                                        fontSize: 18,
                                        fontWeight: "600",
                                        marginBottom: 12,
                                        textAlign: "center",
                                      }}
                                    >
                                      {workerInfo.worker.name}
                                    </Text>

                                    {/* Ï†ÑÌôîÎ≤àÌò∏ */}
                                    <View style={{ marginBottom: 12 }}>
                                      <Text
                                        style={{
                                          fontSize: 12,
                                          color: "#6b7280",
                                          marginBottom: 4,
                                        }}
                                      >
                                        Ï†ÑÌôîÎ≤àÌò∏
                                      </Text>
                                      <Pressable
                                        onPress={() =>
                                          makePhoneCall(workerInfo.worker.phone)
                                        }
                                      >
                                        <Text
                                          style={{
                                            fontSize: 14,
                                            color: "#2563eb",
                                            textDecorationLine: "underline",
                                          }}
                                        >
                                          üìû {workerInfo.worker.phone}
                                        </Text>
                                      </Pressable>
                                    </View>

                                    {/* ÏãúÍ∏â Î∞è Í∑ºÎ¨¥ÏãúÍ∞Ñ */}
                                    <View style={{ marginBottom: 12 }}>
                                      <Text
                                        style={{
                                          fontSize: 12,
                                          color: "#6b7280",
                                          marginBottom: 4,
                                        }}
                                      >
                                        ÏãúÍ∏â
                                      </Text>
                                      <View
                                        style={{
                                          flexDirection: "row",
                                          alignItems: "center",
                                          gap: 8,
                                          marginBottom: 12,
                                        }}
                                      >
                                        <TextInput
                                          style={{
                                            borderWidth: 1,
                                            borderColor: "#d1d5db",
                                            borderRadius: 4,
                                            padding: 6,
                                            backgroundColor: "white",
                                            fontSize: 12,
                                            width: 80,
                                          }}
                                          value={(
                                            workerData[workerInfo.worker.id]
                                              ?.hourlyWage ||
                                            workerInfo.worker.hourlyWage
                                          ).toLocaleString()}
                                          onChangeText={(text: string) => {
                                            const wage = parseInt(
                                              text.replace(/,/g, "")
                                            );
                                            if (!isNaN(wage)) {
                                              updateWorkerData(
                                                workerInfo.worker.id,
                                                {
                                                  hourlyWage: wage,
                                                }
                                              );
                                            }
                                          }}
                                          keyboardType="numeric"
                                          placeholder="ÏãúÍ∏â"
                                        />
                                        <Text
                                          style={{
                                            fontSize: 12,
                                            color: "#6b7280",
                                          }}
                                        >
                                          Ïõê
                                        </Text>
                                      </View>

                                      <Text
                                        style={{
                                          fontSize: 12,
                                          color: "#6b7280",
                                          marginBottom: 4,
                                        }}
                                      >
                                        Í∑ºÎ¨¥ÏãúÍ∞Ñ (ÏãúÍ∞Ñ+Î∂Ñ)
                                      </Text>
                                      <View
                                        style={{
                                          flexDirection: "row",
                                          alignItems: "center",
                                          gap: 8,
                                        }}
                                      >
                                        <TextInput
                                          style={{
                                            borderWidth: 1,
                                            borderColor: "#d1d5db",
                                            borderRadius: 4,
                                            padding: 6,
                                            backgroundColor: "white",
                                            fontSize: 12,
                                            width: 100,
                                          }}
                                          value={formatWorkHours(
                                            workHours[workerInfo.worker.id] ||
                                              workerInfo.periods.reduce(
                                                (
                                                  total: number,
                                                  period: any
                                                ) => {
                                                  const start = dayjs(
                                                    period.start
                                                  );
                                                  const end = dayjs(period.end);
                                                  return (
                                                    total +
                                                    end.diff(
                                                      start,
                                                      "hour",
                                                      true
                                                    )
                                                  );
                                                },
                                                0
                                              )
                                          )}
                                          onChangeText={(text: string) => {
                                            const hours = parseWorkHours(text);
                                            if (!isNaN(hours)) {
                                              updateWorkHours(
                                                workerInfo.worker.id,
                                                hours
                                              );
                                            }
                                          }}
                                          placeholder="2ÏãúÍ∞Ñ 00Î∂Ñ"
                                        />
                                      </View>
                                    </View>

                                    {/* Í∏âÏó¨ Í≥ÑÏÇ∞ */}
                                    <View style={{ marginBottom: 12 }}>
                                      <Text
                                        style={{
                                          fontSize: 12,
                                          color: "#6b7280",
                                          marginBottom: 4,
                                        }}
                                      >
                                        Í∏âÏó¨ Í≥ÑÏÇ∞
                                      </Text>
                                      {(() => {
                                        const pay = calculatePay(workerInfo);
                                        return (
                                          <View
                                            style={{
                                              backgroundColor: "#f0f9ff",
                                              padding: 8,
                                              borderRadius: 4,
                                            }}
                                          >
                                            <Text
                                              style={{
                                                fontSize: 12,
                                                color: "#1f2937",
                                                marginBottom: 2,
                                              }}
                                            >
                                              Ï¥ù Í∏âÏó¨:{" "}
                                              {pay.gross.toLocaleString()}Ïõê
                                            </Text>
                                            {pay.taxWithheld && (
                                              <Text
                                                style={{
                                                  fontSize: 12,
                                                  color: "#dc2626",
                                                  marginBottom: 2,
                                                }}
                                              >
                                                ÏÑ∏Í∏à Í≥µÏ†ú (3.3%): -
                                                {pay.tax.toLocaleString()}Ïõê
                                              </Text>
                                            )}
                                            <Text
                                              style={{
                                                fontSize: 14,
                                                color: "#059669",
                                                fontWeight: "600",
                                              }}
                                            >
                                              Ïã§ÏàòÎ†πÏï°:{" "}
                                              {pay.net.toLocaleString()}Ïõê
                                            </Text>
                                          </View>
                                        );
                                      })()}
                                    </View>

                                    {/* Í≥ÑÏ¢åÎ≤àÌò∏ Î∞è ÏÜ°Í∏à */}
                                    <View style={{ marginBottom: 12 }}>
                                      <Text
                                        style={{
                                          fontSize: 12,
                                          color: "#6b7280",
                                          marginBottom: 4,
                                        }}
                                      >
                                        Í≥ÑÏ¢åÎ≤àÌò∏
                                      </Text>
                                      <View
                                        style={{
                                          flexDirection: "row",
                                          alignItems: "center",
                                          justifyContent: "space-between",
                                        }}
                                      >
                                        <Text
                                          style={{
                                            fontSize: 12,
                                            color: "#1f2937",
                                            flex: 1,
                                          }}
                                        >
                                          {workerInfo.worker.bankAccount}
                                        </Text>
                                        <View
                                          style={{
                                            flexDirection: "row",
                                            gap: 4,
                                          }}
                                        >
                                          <Pressable
                                            onPress={() =>
                                              copyToClipboard(
                                                workerInfo.worker.bankAccount
                                              )
                                            }
                                            style={{
                                              backgroundColor: "#2563eb",
                                              paddingHorizontal: 6,
                                              paddingVertical: 2,
                                              borderRadius: 4,
                                            }}
                                          >
                                            <Text
                                              style={{
                                                color: "white",
                                                fontSize: 10,
                                              }}
                                            >
                                              Î≥µÏÇ¨
                                            </Text>
                                          </Pressable>
                                          <Pressable
                                            onPress={() =>
                                              openPaymentApp(
                                                workerInfo.worker.bankAccount
                                              )
                                            }
                                            style={{
                                              backgroundColor: "#10b981",
                                              paddingHorizontal: 6,
                                              paddingVertical: 2,
                                              borderRadius: 4,
                                            }}
                                          >
                                            <Text
                                              style={{
                                                color: "white",
                                                fontSize: 10,
                                              }}
                                            >
                                              ÏÜ°Í∏à
                                            </Text>
                                          </Pressable>
                                        </View>
                                      </View>
                                    </View>

                                    {/* Í∏âÏó¨ ÏÑ§Ï†ï */}
                                    <View
                                      style={{
                                        borderTopWidth: 1,
                                        borderTopColor: "#e5e7eb",
                                        paddingTop: 8,
                                      }}
                                    >
                                      <View
                                        style={{
                                          flexDirection: "row",
                                          justifyContent: "space-between",
                                          alignItems: "center",
                                          marginBottom: 8,
                                        }}
                                      >
                                        <Text
                                          style={{
                                            fontSize: 12,
                                            color: "#6b7280",
                                          }}
                                        >
                                          ÏÑ∏Í∏àÍ≥µÏ†ú (3.3%)
                                        </Text>
                                        <View
                                          style={{
                                            flexDirection: "row",
                                            gap: 8,
                                          }}
                                        >
                                          <Pressable
                                            onPress={() => {
                                              updateWorkerData(
                                                workerInfo.worker.id,
                                                {
                                                  taxWithheld: true,
                                                }
                                              );
                                            }}
                                            style={{
                                              backgroundColor: (
                                                workerData[workerInfo.worker.id]
                                                  ?.taxWithheld !== undefined
                                                  ? workerData[
                                                      workerInfo.worker.id
                                                    ].taxWithheld
                                                  : workerInfo.worker
                                                      .taxWithheld
                                              )
                                                ? "#2563eb"
                                                : "#e5e7eb",
                                              paddingHorizontal: 8,
                                              paddingVertical: 4,
                                              borderRadius: 4,
                                            }}
                                          >
                                            <Text
                                              style={{
                                                color: (
                                                  workerData[
                                                    workerInfo.worker.id
                                                  ]?.taxWithheld !== undefined
                                                    ? workerData[
                                                        workerInfo.worker.id
                                                      ].taxWithheld
                                                    : workerInfo.worker
                                                        .taxWithheld
                                                )
                                                  ? "white"
                                                  : "#6b7280",
                                                fontSize: 10,
                                                fontWeight: "600",
                                              }}
                                            >
                                              Y
                                            </Text>
                                          </Pressable>
                                          <Pressable
                                            onPress={() => {
                                              updateWorkerData(
                                                workerInfo.worker.id,
                                                {
                                                  taxWithheld: false,
                                                }
                                              );
                                            }}
                                            style={{
                                              backgroundColor: !(workerData[
                                                workerInfo.worker.id
                                              ]?.taxWithheld !== undefined
                                                ? workerData[
                                                    workerInfo.worker.id
                                                  ].taxWithheld
                                                : workerInfo.worker.taxWithheld)
                                                ? "#2563eb"
                                                : "#e5e7eb",
                                              paddingHorizontal: 8,
                                              paddingVertical: 4,
                                              borderRadius: 4,
                                            }}
                                          >
                                            <Text
                                              style={{
                                                color: !(workerData[
                                                  workerInfo.worker.id
                                                ]?.taxWithheld !== undefined
                                                  ? workerData[
                                                      workerInfo.worker.id
                                                    ].taxWithheld
                                                  : workerInfo.worker
                                                      .taxWithheld)
                                                  ? "white"
                                                  : "#6b7280",
                                                fontSize: 10,
                                                fontWeight: "600",
                                              }}
                                            >
                                              N
                                            </Text>
                                          </Pressable>
                                        </View>
                                      </View>

                                      <View
                                        style={{
                                          flexDirection: "row",
                                          justifyContent: "space-between",
                                          alignItems: "center",
                                        }}
                                      >
                                        <Text
                                          style={{
                                            fontSize: 12,
                                            color: "#6b7280",
                                          }}
                                        >
                                          ÏßÄÍ∏âÏôÑÎ£å
                                        </Text>
                                        <Switch
                                          value={
                                            workerData[workerInfo.worker.id]
                                              ?.paid !== undefined
                                              ? workerData[workerInfo.worker.id]
                                                  .paid
                                              : workerInfo.paid
                                          }
                                          onValueChange={(value) => {
                                            updateWorkerData(
                                              workerInfo.worker.id,
                                              {
                                                paid: value,
                                              }
                                            );
                                          }}
                                          style={{
                                            transform: [
                                              { scaleX: 0.8 },
                                              { scaleY: 0.8 },
                                            ],
                                          }}
                                        />
                                      </View>
                                    </View>
                                  </View>
                                ))}
                              </View>
                            </View>
                          );
                        })()}
                      </ScrollView>
                    </View>
                  )}
                </View>
              </View>
            </Animated.View>
          </PanGestureHandler>
        </Animated.View>
      )}

      {/* ÏÉà Í∑ºÎ°úÏûê Ï∂îÍ∞Ä Î™®Îã¨ */}
      <Modal
        visible={showAddWorkerModal}
        transparent={true}
        animationType="slide"
        onRequestClose={() => setShowAddWorkerModal(false)}
      >
        <View
          style={{
            flex: 1,
            backgroundColor: "rgba(0,0,0,0.5)",
            justifyContent: "center",
            alignItems: "center",
          }}
        >
          <View
            style={{
              backgroundColor: "white",
              borderRadius: 12,
              padding: 20,
              width: "90%",
              maxWidth: 400,
            }}
          >
            <Text
              style={{
                fontSize: 18,
                fontWeight: "bold",
                marginBottom: 20,
                textAlign: "center",
              }}
            >
              ÏÉà Í∑ºÎ°úÏûê Ï∂îÍ∞Ä
            </Text>

            <View style={{ marginBottom: 16 }}>
              <Text style={{ fontSize: 14, marginBottom: 4, color: "#374151" }}>
                Ïù¥Î¶Ñ
              </Text>
              <TextInput
                style={{
                  borderWidth: 1,
                  borderColor: "#d1d5db",
                  borderRadius: 6,
                  padding: 12,
                  fontSize: 16,
                }}
                value={newWorker.name}
                onChangeText={(text) =>
                  setNewWorker({ ...newWorker, name: text })
                }
                placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
              />
            </View>

            <View style={{ marginBottom: 16 }}>
              <Text style={{ fontSize: 14, marginBottom: 4, color: "#374151" }}>
                Ï†ÑÌôîÎ≤àÌò∏
              </Text>
              <TextInput
                style={{
                  borderWidth: 1,
                  borderColor: "#d1d5db",
                  borderRadius: 6,
                  padding: 12,
                  fontSize: 16,
                }}
                value={newWorker.phone}
                onChangeText={(text) =>
                  setNewWorker({ ...newWorker, phone: text })
                }
                placeholder="010-1234-5678"
                keyboardType="phone-pad"
              />
            </View>

            <View style={{ marginBottom: 16 }}>
              <Text style={{ fontSize: 14, marginBottom: 4, color: "#374151" }}>
                Í≥ÑÏ¢åÎ≤àÌò∏
              </Text>
              <TextInput
                style={{
                  borderWidth: 1,
                  borderColor: "#d1d5db",
                  borderRadius: 6,
                  padding: 12,
                  fontSize: 16,
                }}
                value={newWorker.bankAccount}
                onChangeText={(text) =>
                  setNewWorker({ ...newWorker, bankAccount: text })
                }
                placeholder="123-456-789"
              />
            </View>

            <View style={{ marginBottom: 16 }}>
              <Text style={{ fontSize: 14, marginBottom: 4, color: "#374151" }}>
                ÏãúÍ∏â (Ïõê)
              </Text>
              <TextInput
                style={{
                  borderWidth: 1,
                  borderColor: "#d1d5db",
                  borderRadius: 6,
                  padding: 12,
                  fontSize: 16,
                }}
                value={newWorker.hourlyWage.toString()}
                onChangeText={(text) => {
                  const wage = parseInt(text) || 0;
                  setNewWorker({ ...newWorker, hourlyWage: wage });
                }}
                placeholder="50000"
                keyboardType="numeric"
              />
            </View>

            <View style={{ marginBottom: 20 }}>
              <Text style={{ fontSize: 14, marginBottom: 8, color: "#374151" }}>
                ÏÑ∏Í∏àÍ≥µÏ†ú
              </Text>
              <View style={{ flexDirection: "row", gap: 12 }}>
                <Pressable
                  onPress={() =>
                    setNewWorker({ ...newWorker, taxWithheld: true })
                  }
                  style={{
                    backgroundColor: newWorker.taxWithheld
                      ? "#2563eb"
                      : "#e5e7eb",
                    paddingHorizontal: 16,
                    paddingVertical: 8,
                    borderRadius: 6,
                    flex: 1,
                  }}
                >
                  <Text
                    style={{
                      color: newWorker.taxWithheld ? "white" : "#6b7280",
                      textAlign: "center",
                      fontWeight: "600",
                    }}
                  >
                    Y (3.3% Í≥µÏ†ú)
                  </Text>
                </Pressable>
                <Pressable
                  onPress={() =>
                    setNewWorker({ ...newWorker, taxWithheld: false })
                  }
                  style={{
                    backgroundColor: !newWorker.taxWithheld
                      ? "#2563eb"
                      : "#e5e7eb",
                    paddingHorizontal: 16,
                    paddingVertical: 8,
                    borderRadius: 6,
                    flex: 1,
                  }}
                >
                  <Text
                    style={{
                      color: !newWorker.taxWithheld ? "white" : "#6b7280",
                      textAlign: "center",
                      fontWeight: "600",
                    }}
                  >
                    N (Í≥µÏ†ú ÏóÜÏùå)
                  </Text>
                </Pressable>
              </View>
            </View>

            <View style={{ flexDirection: "row", gap: 12 }}>
              <Pressable
                onPress={() => setShowAddWorkerModal(false)}
                style={{
                  backgroundColor: "#6b7280",
                  paddingVertical: 12,
                  borderRadius: 6,
                  flex: 1,
                }}
              >
                <Text
                  style={{
                    color: "white",
                    textAlign: "center",
                    fontWeight: "600",
                  }}
                >
                  Ï∑®ÏÜå
                </Text>
              </Pressable>
              <Pressable
                onPress={handleAddWorker}
                style={{
                  backgroundColor: "#10b981",
                  paddingVertical: 12,
                  borderRadius: 6,
                  flex: 1,
                }}
              >
                <Text
                  style={{
                    color: "white",
                    textAlign: "center",
                    fontWeight: "600",
                  }}
                >
                  Ï∂îÍ∞Ä
                </Text>
              </Pressable>
            </View>
          </View>
        </View>
      </Modal>
    </View>
  );
}
